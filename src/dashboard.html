<!DOCTYPE html>
<html>
<head>
    <title>Analytics Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .graph {
            margin-bottom: 30px;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: white;
            font-size: 14px;
        }
        label {
            font-weight: 500;
            color: #444;
        }
        .metrics-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            gap: 20px;
        }
        .metric {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
        }
        .metric h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
        .metric p {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Analytics Dashboard</h1>
        
        <div class="filters">
            <div class="filter-group"></div>
                <label for="metric">Metric:</label>
                <select id="metric" onchange="updateFilters()">
                    <option value="UniqueVisitors">Unique Visitors</option>
                    <option value="Visits">Total Visits</option>
                    <option value="Pageviews">Total Pageviews</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="timeframe">Time Frame:</label>
                <select id="timeframe" onchange="updateFilters()">
                    <option value="Today">Today</option>
                    <option value="Yesterday">Yesterday</option>
                    <option value="Last7Days">Last 7 Days</option>
                    <option value="Last30Days">Last 30 Days</option>
                    <option value="AllTime">All Time</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="granularity">Show by:</label>
                <select id="granularity" onchange="fetchData()">
                    <option value="Minutes">Minutes</option>
                    <option value="Hours">Hours</option>
                    <option value="Days">Days</option>
                </select>
            </div>
        </div>

        <div class="metrics-container">
            <div class="metric">
                <h3>Unique Visitors</h3>
                <p id="unique-visitors">-</p>
            </div>
            <div class="metric">
                <h3>Total Visits</h3>
                <p id="total-visits">-</p>
            </div>
            <div class="metric">
                <h3>Total Pageviews</h3>
                <p id="total-pageviews">-</p>
            </div>
        </div>

        <div id="statsGraph" class="graph"></div>
    </div>

    <script>
        function updateFilters() {
            const metric = document.getElementById('metric').value;
            const timeframe = document.getElementById('timeframe').value;
            const granularitySelect = document.getElementById('granularity');
            
            granularitySelect.innerHTML = '';
            
            if (timeframe === 'Today' || timeframe === 'Yesterday') {
                granularitySelect.add(new Option('Minutes', 'Minutes'));
                granularitySelect.add(new Option('Hours', 'Hours'));
            } else {
                granularitySelect.add(new Option('Hours', 'Hours'));
                granularitySelect.add(new Option('Days', 'Days'));
            }
            
            fetchData();
        }

        
        function updateStatistics(data) {
            document.getElementById('unique-visitors').textContent = data.aggregates.unique_visitors;
            document.getElementById('total-visits').textContent = data.aggregates.total_visits;
            document.getElementById('total-pageviews').textContent = data.aggregates.total_pageviews;
        }

        async function fetchData() {
            const timeframe = document.getElementById('timeframe').value;
            const granularity = document.getElementById('granularity').value;
            const metric = document.getElementById('metric').value;
            const response = await fetch(`/api/statistics?timeframe=${timeframe}&granularity=${granularity}&metric=${metric}`);
            const data = await response.json();
            
            const trace = {
                x: data.stats.map(([timestamp]) => new Date(timestamp * 1000)),
                y: data.stats.map(([, visitors]) => visitors),
                type: 'scatter',
                mode: 'lines+markers',
                name: metric,
                connectgaps: false,
                line: {
                    shape: 'hv',  // Creates a stepped line
                }
            };
            
            const title = `${metric} (${timeframe})`;
            const xaxisTitle = granularity === 'Days' ? 'Date' : 'Time';
            
            let xaxisFormat;
            switch(granularity) {
                case 'Minutes':
                    xaxisFormat = '%H:%M';
                    break;
                case 'Hours':
                    xaxisFormat = '%H:00';
                    break;
                case 'Days':
                    xaxisFormat = '%Y-%m-%d';
                    break;
            }
            
            Plotly.newPlot('statsGraph', [trace], {
                title: title,
                xaxis: { 
                    title: xaxisTitle,
                    tickformat: xaxisFormat,
                    showgrid: true
                },
                yaxis: { 
                    title: metric,
                    rangemode: 'nonnegative',  // Prevents negative values
                    showgrid: true
                },
                showlegend: false,
                hovermode: 'x unified',
                hoverlabel: {
                    namelength: -1  // Show full label text
                },
                margin: { t: 50, r: 20, l: 50, b: 50 }
            });

            updateStatistics(data);
        }

        // Initialize filters and data
        updateFilters();
        
        // Update every minute if showing current day
        setInterval(() => {
            if (document.getElementById('timeframe').value === 'Today') {
                fetchData();
            }
        }, 60000);
    </script>
</body>
</html> 