<!DOCTYPE html>
<html>
<head>
    <title>Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .graph {
            margin-bottom: 30px;
            position: relative;
            width: 100%;
            padding-bottom: 42.85%;
        }
        .graph canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: white;
            font-size: 14px;
        }
        label {
            font-weight: 500;
            color: #444;
        }
        .metrics-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            gap: 20px;
        }
        .metric {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
        }
        .metric h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
        .metric p {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .location-filter {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        .tables-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        .location-table {
            flex: 1;
            min-width: 300px;
            max-width: 400px;
            margin: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .location-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .location-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            color: #666;
            border-bottom: 1px solid #ddd;
        }
        .location-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        .location-table tr:last-child td {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Analytics Dashboard</h1>
        
        <div class="filters">
            <div class="filter-group">
                <label for="metric">Metric:</label>
                <select id="metric" onchange="updateFilters()">
                    <option value="UniqueVisitors" selected>Unique Visitors</option>
                    <option value="Visits">Total Visits</option>
                    <option value="Pageviews">Total Pageviews</option>
                    <option value="AvgVisitDuration">Avg Visit Duration</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="timeframe">Time Frame:</label>
                <select id="timeframe" onchange="updateFilters()">
                    <option value="Realtime">Realtime</option>
                    <option value="Today" selected>Today</option>
                    <option value="Yesterday">Yesterday</option>
                    <option value="Last7Days">Last 7 Days</option>
                    <option value="Last30Days">Last 30 Days</option>
                    <option value="AllTime">All Time</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="granularity">Show by:</label>
                <select id="granularity" onchange="updateFilters()">
                    <option value="Minutes">Minutes</option>
                    <option value="Hours" selected>Hours</option>
                    <option value="Days">Days</option>
                </select>
            </div>
        </div>

        <div class="metrics-container">
            <div class="metric">
                <h3>Current Visitors</h3>
                <p id="current-visits">-</p>
            </div>
            <div class="metric">
                <h3>Unique Visitors</h3>
                <p id="unique-visitors">-</p>
            </div>
            <div class="metric">
                <h3>Total Visits</h3>
                <p id="total-visits">-</p>
            </div>
            <div class="metric">
                <h3>Total Pageviews</h3>
                <p id="total-pageviews">-</p>
            </div>
            <div class="metric">
                <h3>Avg Visit Duration</h3>
                <p id="avg-visit-duration">-</p>
            </div>
        </div>

        <div class="graph">
            <canvas id="statsGraph"></canvas>
        </div>

        <div class="location-filter">
            <div class="filter-group">
                <label for="location-grouping">Location Detail:</label>
                <select id="location-grouping" onchange="updateFilters()">
                    <option value="Country" selected>Country</option>
                    <option value="Region">Region</option>
                    <option value="City">City</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="device-grouping">Device Detail:</label>
                <select id="device-grouping" onchange="updateFilters()">
                    <option value="Browser" selected>Browser</option>
                    <option value="OperatingSystem">Operating System</option>
                    <option value="DeviceType">Device Type</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="source-grouping">Source Detail:</label>
                <select id="source-grouping" onchange="updateFilters()">
                    <option value="Source" selected>Source</option>
                    <option value="Referrer">Referrer</option>
                    <option value="Campaign">Campaign</option>
                </select>
            </div>
        </div>

        <div class="tables-container">
            <div class="location-table">
                <table>
                    <thead>
                        <tr>
                            <th id="location-grouping-label">Country</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody id="location-data">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="location-table">
                <table>
                    <thead>
                        <tr>
                            <th id="device-grouping-label">Browser</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody id="device-data">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="location-table">
                <table>
                    <thead>
                        <tr>
                            <th id="source-grouping-label">Source</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody id="source-data">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                metric: params.get('metric') || 'UniqueVisitors',
                timeframe: params.get('timeframe') || 'Today',
                granularity: params.get('granularity') || 'Hours',
                locationGrouping: params.get('locationGrouping') || 'Country',
                deviceGrouping: params.get('deviceGrouping') || 'Browser',
                sourceGrouping: params.get('sourceGrouping') || 'Source'
            };
        }

        function updateQueryParams() {
            const metric = document.getElementById('metric').value;
            const timeframe = document.getElementById('timeframe').value;
            const granularity = document.getElementById('granularity').value;
            const locationGrouping = document.getElementById('location-grouping').value;
            const deviceGrouping = document.getElementById('device-grouping').value;
            const sourceGrouping = document.getElementById('source-grouping').value;
            
            const params = new URLSearchParams();
            params.set('metric', metric);
            params.set('timeframe', timeframe);
            params.set('granularity', granularity);
            params.set('locationGrouping', locationGrouping);
            params.set('deviceGrouping', deviceGrouping);
            params.set('sourceGrouping', sourceGrouping);
            
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.pushState({}, '', newUrl);
        }

        function updateFilters() {
            const metric = document.getElementById('metric').value;
            const timeframe = document.getElementById('timeframe').value;
            const granularitySelect = document.getElementById('granularity');
            const granularity = granularitySelect.value;
            
            granularitySelect.innerHTML = '';

            const newOptions = [];
            
            if (timeframe === 'Realtime') {
                newOptions.push(new Option('Minutes', 'Minutes'));
            } else if (timeframe === 'Today' || timeframe === 'Yesterday') {
                newOptions.push(new Option('Minutes', 'Minutes'));
                newOptions.push(new Option('Hours', 'Hours'));
            } else {
                newOptions.push(new Option('Hours', 'Hours'));
                newOptions.push(new Option('Days', 'Days'));
            }

            for (const option of newOptions) {
                granularitySelect.add(option);
            }

            if (newOptions.length > 0 && newOptions.some(option => option.value === granularity)) {
                granularitySelect.value = granularity;
            } 
            
            updateQueryParams();
            fetchData();
        }

        function formatDuration(seconds) {
            if (!seconds && seconds !== 0) return '-';
            
            if (seconds < 60) {
                return `${seconds}s`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}m ${remainingSeconds}s`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}h ${minutes}m`;
            }
        }

        function updateStatistics(data) {
            document.getElementById('unique-visitors').textContent = data.aggregates.unique_visitors;
            document.getElementById('total-visits').textContent = data.aggregates.total_visits;
            document.getElementById('total-pageviews').textContent = data.aggregates.total_pageviews;
            document.getElementById('current-visits').textContent = data.realtime_aggregates.current_visits;
            
            document.getElementById('avg-visit-duration').textContent = formatDuration(data.aggregates.avg_visit_duration);
            
            document.getElementById('location-grouping-label').textContent = document.getElementById('location-grouping').value;
            document.getElementById('device-grouping-label').textContent = document.getElementById('device-grouping').value;
            document.getElementById('source-grouping-label').textContent = document.getElementById('source-grouping').value;

            // Update location table
            const locationTableBody = document.getElementById('location-data');
            locationTableBody.innerHTML = '';
            
            if (data.location_metrics) {
                const locationGrouping = document.getElementById('location-grouping').value;
                const metric = document.getElementById('metric').value;

                data.location_metrics.forEach(({country, region, city, visitors, visits, pageviews, avg_visit_duration}) => {
                    const row = document.createElement('tr');
                    let value = visitors;
                    let grouping = country;

                    switch(metric) {
                        case 'UniqueVisitors':
                            value = visitors;
                            break;
                        case 'Visits':
                            value = visits;
                            break;
                        case 'Pageviews':
                            value = pageviews;
                            break;
                        case 'AvgVisitDuration':
                            value = formatDuration(avg_visit_duration);
                            break;
                    }

                    switch(locationGrouping) {
                        case 'Country':
                            grouping = country;
                            break;
                        case 'Region':
                            grouping = region;
                            break;
                        case 'City':
                            grouping = city;
                            break;
                    }
                    
                    row.innerHTML = `
                        <td>${grouping}</td>
                        <td>${value}</td>
                    `;
                    locationTableBody.appendChild(row);
                });
            }

            // Update device table
            const deviceTableBody = document.getElementById('device-data');
            deviceTableBody.innerHTML = '';
            
            if (data.device_metrics) {
                const deviceGrouping = document.getElementById('device-grouping').value;
                const metric = document.getElementById('metric').value;

                data.device_metrics.forEach(({browser, operating_system, device_type, visitors, visits, pageviews, avg_visit_duration}) => {
                    const row = document.createElement('tr');
                    let value = visitors;
                    let grouping = browser;

                    switch(metric) {
                        case 'UniqueVisitors':
                            value = visitors;
                            break;
                        case 'Visits':
                            value = visits;
                            break;
                        case 'Pageviews':
                            value = pageviews;
                            break;
                        case 'AvgVisitDuration':
                            value = formatDuration(avg_visit_duration);
                            break;
                    }

                    switch(deviceGrouping) {
                        case 'Browser':
                            grouping = browser;
                            break;
                        case 'OperatingSystem':
                            grouping = operating_system;
                            break;
                        case 'DeviceType':
                            grouping = device_type;
                            break;
                    }
                    
                    row.innerHTML = `
                        <td>${grouping}</td>
                        <td>${value}</td>
                    `;
                    deviceTableBody.appendChild(row);
                });
            }

            // Update source table
            const sourceTableBody = document.getElementById('source-data');
            sourceTableBody.innerHTML = '';
            
            if (data.source_metrics) {
                const sourceGrouping = document.getElementById('source-grouping').value;
                const metric = document.getElementById('metric').value;

                data.source_metrics.forEach(({source, referrer, utm_source, utm_medium, utm_campaign, visitors, visits, pageviews, avg_visit_duration}) => {
                    const row = document.createElement('tr');
                    let value = visitors;
                    let grouping = source;

                    switch(metric) {
                        case 'UniqueVisitors':
                            value = visitors;
                            break;
                        case 'Visits':
                            value = visits;
                            break;
                        case 'Pageviews':
                            value = pageviews;
                            break;
                        case 'AvgVisitDuration':
                            value = formatDuration(avg_visit_duration);
                            break;
                    }

                    switch(sourceGrouping) {
                        case 'Source':
                            grouping = source;
                            break;
                        case 'Referrer':
                            grouping = referrer || 'Direct';
                            break;
                        case 'Campaign':
                            if (utm_source || utm_medium || utm_campaign) {
                                grouping = `${utm_source || '-'}/${utm_medium || '-'}/${utm_campaign || '-'}`;
                            } else {
                                grouping = 'No Campaign';
                            }
                            break;
                    }
                    
                    row.innerHTML = `
                        <td>${grouping}</td>
                        <td>${value}</td>
                    `;
                    sourceTableBody.appendChild(row);
                });
            }
        }

        let chart;

        async function fetchData() {
            const timeframe = document.getElementById('timeframe').value;
            const granularity = document.getElementById('granularity').value;
            const metric = document.getElementById('metric').value;
            const locationGrouping = document.getElementById('location-grouping').value;
            const deviceGrouping = document.getElementById('device-grouping').value;
            const sourceGrouping = document.getElementById('source-grouping').value;
            
            const response = await fetch(`/api/statistics?timeframe=${timeframe}&granularity=${granularity}&metric=${metric}&location_grouping=${locationGrouping}&device_grouping=${deviceGrouping}&source_grouping=${sourceGrouping}`);
            const data = await response.json();
            
            const timestamps = data.stats.map(([timestamp]) => {
                const date = new Date(timestamp * 1000);
                switch(granularity) {
                    case 'Minutes':
                        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    case 'Hours':
                        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    case 'Days':
                        return date.toLocaleDateString();
                }
            });

            const values = data.stats.map(([, value]) => value);

            if (!chart) {
                const ctx = document.getElementById('statsGraph').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timestamps,
                        datasets: [{
                            label: metric,
                            data: values,
                            tension: 0.1,
                            fill: true,
                            stepped: false,
                            cubicInterpolationMode: 'monotone',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderColor: 'rgba(33, 150, 243, 0.3)',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 7/3,
                        plugins: {
                            title: {
                                display: true,
                                text: `${metric} (${timeframe})`
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        },
                        interaction: {
                            intersect: false,
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: granularity === 'Days' ? 'Date' : 'Time'
                                },
                                grid: {
                                    display: true
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: metric
                                },
                                beginAtZero: true,
                                grid: {
                                    display: true
                                },
                                suggestedMax: Math.max(...values) * 1.1,
                                ticks: {
                                    padding: 10
                                }
                            }
                        }
                    }
                });
            } else {
                chart.data.labels = timestamps;
                chart.data.datasets[0].data = values;
                chart.data.datasets[0].label = metric;
                chart.options.plugins.title.text = `${metric} (${timeframe})`;
                chart.options.scales.x.title.text = granularity === 'Days' ? 'Date' : 'Time';
                chart.options.scales.y.title.text = metric;
                chart.options.scales.y.suggestedMax = Math.max(...values) * 1.1;
                chart.update();
            }

            updateStatistics(data);
        }

        // Initialize filters from URL params
        const initialParams = getQueryParams();
        document.getElementById('metric').value = initialParams.metric;
        document.getElementById('timeframe').value = initialParams.timeframe;
        document.getElementById('granularity').value = initialParams.granularity;
        document.getElementById('location-grouping').value = initialParams.locationGrouping;
        document.getElementById('device-grouping').value = initialParams.deviceGrouping;
        document.getElementById('source-grouping').value = initialParams.sourceGrouping;

        // Initialize filters and data
        updateFilters();
        
        // Update interval based on timeframe
        setInterval(() => {
            fetchData();
        }, 10000);
    </script>
</body>
</html> 